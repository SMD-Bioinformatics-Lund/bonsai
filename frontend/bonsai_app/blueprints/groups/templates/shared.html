{% from  'sidebar.html' import qc_classification_form_fields  %}
{% import "cell_fmt.html" as render_funcs with context %}

{% macro add_to_basket_btn() %}
<button id="add-to-basket-btn" class="btn btn-sm btn-outline-success" data-test-id="add-to-basket-btn" disabled>
    <i class="bi bi-plus-lg"></i>
    <span>Add to basket</span>
</button>
{% endmacro %}

{% macro search_similar_btn() %}
<div id="find-similar-dropdown" class="dropdown similar-samples-container">
    <button id="similar-samples-dropdown-btn"
            class="btn btn-sm btn-outline-secondary dropdown-toggle ms-4" 
            data-bs-toggle="dropdown" disabled>
        <span class="content">
            <i class="bi bi-search"></i>
            <span>Find similar</span>
        </span>
        <span class="loading align-middle d-none">
            <span class="spinner-grow text-success spinner-grow-sm" role="status"></span>
            Loading...
        </span>
    </button>
    <div class="dropdown-menu dropdown-menu-end p-2" style="min-width: 300px;">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="dropdown-header mb-0">Find Similar Samples</h6>
            <span class="ms-2" data-bs-toggle="tooltip" data-bs-placement="left"
                title="Enter a minimum similarity percentage (0â€“100). Optionally set a maximum number of results. Click 'Find Similar Samples' to search.">
            <i class="bi bi-info-circle" style="cursor: help;"></i>
            </span>
        </div>
        <form class="needs-validation">
            <div class="mb-2">
                <label for="similar-samples-threshold" class="form-label">Minimum similarity (%)</label>
                <input type="number" min="0" max="1" step="0.01" name="similar-samples-threshold" 
                        id="similar-samples-threshold" class="form-control form-control-sm" 
                        placeholder="Min similarity" value="0.95" required>
                <div id="similar-samples-limit-help" class="form-text">Include samples with similarity above this percentage. Example: 95 = 95%.</div>
            </div>
            <div class="mb-2">
                <label for="similar-samples-limit" class="form-label">Maximum results</label>
                <input type="number" name="similar-samples-limit" 
                        id="similar-samples-limit" class="form-control form-control-sm" 
                        placeholder="Number of samples" value="50" required>
                <div id="similar-samples-limit-help" class="form-text">Limit the number of samples returned.</div>
            </div>
            <button type="button" id="select-similar-samples-btn" class="btn btn-sm btn-outline-success mt-2" >
                <i class="bi bi-search"></i>
                Find similar samples
            </button>
        </form>
    </div>
</div>
{% endmacro %}


{% macro qc_bulk_toggle(bad_qc_actions) %}
    {#

        Button interacting with sample list in groups. Activates pop up dialog when used.

        Inputs:
            - bad_qc_actions : List[str]    List of selectable follow-up actions for failed samples

    #}
    <div id="qc-menu-dropdown" class="dropdown">
        <button
            id="toggle-qc-btn"
            class="btn btn-sm btn-outline-secondary dropdown-toggle ms-4"
            data-bs-toggle="dropdown" data-bs-auto-close="outside"
            disabled
        >
            Set QC status
        </button>
        <form
            class="needs-validation"
            method="post"
            id="qc-form-control"
            action="{{ url_for('groups.update_qc_classification') }}"
        >
            <div id="qc-dropdown-contents" class="dropdown-menu dropdown-menu-end p-2">
                {{ qc_classification_form_fields(
                    bad_qc_actions=bad_qc_actions,
                    selected_qc_status = "",
                    selected_action = "",
                    comment_text = ""
                ) }}
            </div>
        </form>
    </div>
{% endmacro %}

{% macro delete_samples_btn() %}
    <button id="remove-samples-btn" class="btn btn-sm btn-outline-danger ms-1" disabled>
        <i class="bi bi-trash"></i>
        <span>Delete samples</span>
    </button>
{% endmacro %}

{% macro sample_table(table_data) %}
    {# build sample table #}
    <p>Group id inside table: {{ group_id }}</p>
    <table id="sample-table" class="display table table-striped">
        <thead>
            <tr>
                {# build table header #}
                {% for column in table_data.columns %}
                    {% if column.label is not none %}
                        <th 
                            data-orderable="{{ column.sortable | lower }}" data-searchable="{{ column.searchable | lower }}"
                            data-visible="{{ column.visible | lower }}"
                            >
                            {{ column.label }}
                        </th>
                    {% else %}
                        <th></th>
                    {% endif %}
                {% endfor %}
            </th>
        </thead>
        <tbody>
            {% for row in table_data.rows %}
                <tr id="{{ row.sample_id }}" {% if test_id is not none %}data-test-id="sample-row-{{ loop.index }}"{% endif %}>
                    {% for col_info in table_data.columns %}
                        {% set cell_data=row[col_info.id] %}
                        {{ render_funcs[col_info.renderer](cell_data) }}
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% endmacro %}


{% macro render_cell(cell_info) %}
    {% set style = cell_info.style or '' %}
    {% set tooltip = cell_info.tooltip or '' %}
    {% set link = cell_info.link %}
    {% set data = cell_info.data %}
    {% set macro = cell_info.render_macro %}

    {% if cell_info.type == "list" %}
        {% set data = data | join(', ') %}
    {% elif cell_info.type == "number" %}
        {% set data = data | fmt_number %}
    {% endif %}

    {% if macro %}
        {{ render_funcs[macro](cell_info) }}
    {% else %}
        <td class="{{ style }}" 
            {% if tooltip %}
                data-bs-toggle="tooltip" data-bs-placement="top"
                data-bs-title="{{ cell_info.tooltip }}">
            {% endif %}
        >
            {{ data }}
        </td>
    {% endif %}
{% endmacro %}
